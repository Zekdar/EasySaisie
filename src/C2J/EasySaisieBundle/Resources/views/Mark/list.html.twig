
{% extends 'C2JEasySaisieBundle::base.html.twig' %}

{% block body %}
    {{ parent() }}
    {% if 
		studentPromotions is not empty 
		and containers is not empty 
		and containersColspan is not empty 
		and subjectsByTuc is not empty 
	%}
        <div>
            <h1 class="page-header">Notes des étudiants de {{studentPromotions[0].promotion }} {{ studentPromotions[0].promotion.year}}</h1>
        </div>

        <div>
            <a href="#displayMarks" class="btn btn-default" id="switchDisplayMarks"><span class="glyphicon glyphicon-list purple"></span> Notes</a>
            <a href="#displayContainersAvg" class="btn btn-default" id="switchDisplayContainersAvg"><span class="glyphicon glyphicon-sort-by-attributes purple"></span> Moyennes générales</a>
        </div>

        <div class="btn-group">
            <a href="#" class="btn btn-info btn-xs" id="">Session 1</a>    
            <a href="#" class="btn btn-default btn-xs" id="">Session 2</a>    
            <a href="#" class="btn btn-default btn-xs" id="">PV Final</a>
			<a href="#" class="btn btn-success btn-xs" id="btnExport">Export Excel</a>  
        </div>

        <hr />

        <!-- DISPLAY MARKS -->        
        <div id="displayMarks">
            <!-- MARKS TABLE -->
            <table class="table table-bordered table-bordered exportable" id="marksTable">
                <thead>
                    <tr>
                        <th data-sorter="false"></th>
                        <th data-sorter="false"></th>
                        {% for container in containers %}
                            <th 
                                data-sorter="false" 
                                data-aretuscompensable="{{ container.areteachingunitscompensable ? 1 : 0 }}"
                                data-minmark="{{ container.minMark }}"
                                data-minavg="{{ container.minAverage }}"                                
                                colspan="{{ containersColspan[loop.index - 1] }}">
                                {{ container.name }}
                            </th>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th data-sorter="false"></th>
                        <th data-sorter="false"></th>
                        {% for container in containers %}							
                            {% for tuc in container.teachingUnitContainers %} 
                                {# +1 to take in account the avg column #}
                                <th 
                                    data-sorter="false" 
                                    colspan="{{ tuc.teachingUnitContainerSubjects | length + 1}}" 
                                    data-iscompensable="{{ tuc.teachingUnit.isCompensable ? 1 : 0 }}"
                                    data-tucode="{{ tuc.teachingUnit.code }}">
                                    {{ tuc.teachingUnit.code }} {{ tuc.teachingUnit.name }}
                                </th>
                            {% endfor %}
                        {% endfor %}
                    </tr>
                    <tr>
                        <th>Num. Etudiant</th>
                        <th>Etudiant</th>
                        {% for container in containers %}
                            {% for tuc in container.teachingUnitContainers %}
                                <th class="tuAvg"><img src="{{ asset('bundles/c2jeasysaisie/img/xbar.png') }}" /></th>
                                {% for tucs in tuc.teachingUnitContainerSubjects %}
                                    <th class="subject">{{ tucs.subject.abbreviation }}</th>
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    </tr>
                    <tr>
                        <th data-sorter="false"></th>
                        <th data-sorter="false"></th>
                        {% for container in containers %}
                            {% for tuc in container.teachingUnitContainers %}
                                <th></th>
                                {% for tucs in tuc.teachingUnitContainerSubjects %}
                                    <th data-sorter="false"><a href=""><span class="glyphicon glyphicon-plus purple"></span></a></th>
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for sp in studentPromotions %}
                        {% set spId = sp.id %} {# declared here to use it after the for loop #}
                        <tr>
                            <td>{{ sp.student.number }}</td>
                            <td class="studentName"><b>{{ sp.student.lastName }}</b> {{ sp.student.firstName }}</td>   							
							{% for tuCode,tu in subjectsByTuc %}	
							
							
                                <td class="tuAvg" data-coeff="{{ sumCoeffs[loop.index0] }}" data-containername="{{ tu[0].container }}"></td>
                                {% for tuId in tu %}									
                                    {% set markId = '' %} {# declared here to use it after the for loop #}
                                    {% set tusId = '' %} {# declared here to use it after the for loop #}
                                    {% set markValue = '' %}
                                
                                    {% set continue = true %} {# used to simulate a break in php because it's not available in Twig #}
                                    {% for mark in sp.marks if continue %}
                                        {% if mark.teachingUnitContainerSubject.subject.id == tuId.subject.id and mark.session == session %}
                                            {% set markValue = mark.value %}
                                            {% set markId = mark.id %}
                                            {% set continue = false %}
                                        {% endif %}
                                    {% endfor %} 		
                                    <td class="tdMark">
                                        <a 
                                            href="" 
                                            class="mark"
                                            data-containername="{{ tu[0].container }}"
                                            data-session="{{ session }}"
                                            data-tucode="{{ tuCode }}" 
                                            data-coeff="{{ tuId.subject.coeff }}"
                                            data-pk="{{ markId }}"
                                            data-spid="{{ spId }}"
                                            data-tucsid="{{ tuId.tucsId }}" 											
                                            data-type="text" 
                                            data-url="{{ path('mark_persist_ajax') }}">
                                            {{ markValue }}
                                        </a>
                                    </td>
                                {% endfor %}
                            {% endfor %}
                        </tr> 
                    {% endfor %} 
                </tbody>
            </table>

            <hr />

            <!-- AVG TABLE -->
            <table class="table table-bordered table-bordered table-striped" id="avgTable">
                <tbody>

                </tbody>
            </table>                   
        </div>

        <!-- DISPLAY CONTAINERS AVG -->
        <div id="displayContainersAvg" style="display: hidden;">
            <table class="table table-bordered table-bordered exportable" id="containersAvgTable">
                <thead>
                    <tr>
                        <th>Num. Etudiant</th>
                        <th>Etudiant</th>
                        {% for container in containers %}
                            <th><img src="{{ asset('bundles/c2jeasysaisie/img/xbar.png') }}" /> {{ container.name }}</th>
                        {% endfor %}
                        <th><img src="{{ asset('bundles/c2jeasysaisie/img/xbar.png') }}" /> Générale</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sp in studentPromotions %}
                        <tr>
                            <td>{{ sp.student.number }}</td>
                            <td class="studentName"><b>{{ sp.student.lastName }}</b> {{ sp.student.firstName }}</td>
                            {% for container in containers %}
                                <td class="avg" data-containername="{{ container }}"></td>
                            {% endfor %}
                            <td class="generalAvg"></td>
                        </tr> 
                    {% endfor %} 
                </tbody> 
            </table>

            <hr />
            
            <!-- STUDENTS AVG TABLE -->
            <table class="table table-bordered table-bordered table-striped" id="studentsAvgTable">
                <thead>
                    <th></th>
                    {% for container in containers %}
                        <th><img src="{{ asset('bundles/c2jeasysaisie/img/xbar.png') }}" /> {{ container.name }}</th>
                    {% endfor %}
                    <th><img src="{{ asset('bundles/c2jeasysaisie/img/xbar.png') }}" /> Générale</th>
                </thead>
                <tbody>
                <tr>
                    <td><b>Moyenne</b></td>
                    {% for container in containers %}
                        <td></td>
                    {% endfor %}
                    <td></td>
                </tr>
                <tr>
                    <td><b>Min</b></td>
                    {% for container in containers %}
                        <td></td>
                    {% endfor %}
                    <td></td>
                </tr>
                <tr>
                    <td><b>Max</b></td>
                    {% for container in containers %}
                        <td></td>
                    {% endfor %}
                    <td></td>
                </tr>
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="center no-reccords-to-display">Il n'y a pas de notes à afficher pour cette promotion.</p>
    {% endif %}

    <hr />
    
    <div class="row">
        <p class="center">            
            <a href="{{ path('mark') }}" class="btn btn-purple btn-sm"><span class="glyphicon glyphicon-hand-left"></span> Retour à la liste</a>
        </p>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="{{ asset('bundles/c2jeasysaisie/js/marks.js') }}"></script>
{% endblock %}
